---
import { getCollection } from 'astro:content';
import { TutorialWorkspace } from '../../components/tutorial/TutorialWorkspace';
import '../../styles/custom.css';
import StarlightPage from '@astrojs/starlight/components/StarlightPage.astro';

export async function getStaticPaths() {
  const tutorialEntries = await getCollection('docs', ({ id }) => {
    return id.startsWith('tutorial/');
  });
  
  console.log('[Tutorial] Found entries:', tutorialEntries.map(e => e.id));

  const sorted = tutorialEntries.sort((a, b) => a.id.localeCompare(b.id));

  return sorted.map((entry) => {
    // Remove tutorial/ prefix and any file extension
    const slug = entry.id.replace(/^tutorial\//, '').replace(/\.[^/.]+$/, '');
    return {
      params: { slug },
      props: { 
        slug
      },
    };
  });
}

const { slug } = Astro.props;

// Fetch all tutorial steps for the SPA
const tutorialEntries = await getCollection('docs', ({ id }) => id.startsWith('tutorial/'));
const sortedEntries = tutorialEntries.sort((a, b) => a.id.localeCompare(b.id));

const allSteps = sortedEntries.map(entry => ({
    slug: entry.id.replace(/^tutorial\//, '').replace(/\.[^/.]+$/, ''),
    title: entry.data.title,
    description: entry.data.description,
    content: entry.body,
    files: (entry.data.files || []).map(f => ({
        path: f.path,
        initialContent: f.initial,
        solutionContent: f.solution,
        editable: f.editable,
        deletable: f.deletable
    })),
    behaviors: entry.data.behaviors,
    successCriteria: entry.data.successCriteria,
    hints: entry.data.hints,
    initialRoute: entry.data.initialRoute,
    pagesDir: entry.data.pagesDir
}));

// Find current step index for display title
const currentIndex = allSteps.findIndex(s => s.slug === slug);
const displayTitle = `Interactive Tutorial | ${String(currentIndex + 1).padStart(2, '0')}. ${allSteps[currentIndex]?.title || 'Loading'}`;

---

<StarlightPage 
    frontmatter={{ 
        title: displayTitle,
        template: 'splash',
        prev: false,
        next: false
    }}
    hasSidebar={false}
>
    <style is:global>
        /* 
         * NUCLEAR RESET: Remove ALL Starlight layout constraints.
         * We manually define flex utilities because Tailwind may not be loaded.
         */
         
        /* 1. Define missing utilities */
        .flex { display: flex !important; }
        .flex-col { flex-direction: column !important; }
        .flex-1 { flex: 1 1 0% !important; }
        .h-full { height: 100% !important; }
        .w-full { width: 100% !important; }
        .overflow-hidden { overflow: hidden !important; }

        /* 2. Global Reset */
        html, body {
            height: 100vh !important;
            width: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
            overflow: hidden !important;
        }

        /* 3. Starlight Layout Hierarchy Reset */
        .page {
            height: 100vh !important;
            display: flex !important;
            flex-direction: column !important;
        }

        .main-frame {
            flex: 1 !important;
            display: flex !important;
            flex-direction: column !important;
            padding: 0 !important;
            padding-top: var(--sl-nav-height) !important;
            height: calc(100vh - var(--sl-nav-height)) !important;
        }

        /* Unwrap nested layout divs so they don't trap height/width */
        .lg\:sl-flex, .main-pane, .content-panel, .sl-container, .sl-markdown-content {
            display: contents !important;
        }

        main {
            flex: 1 !important;
            display: flex !important;
            flex-direction: column !important;
            padding: 0 !important;
            margin: 0 !important;
            width: 100% !important;
            height: 100% !important;
            overflow: hidden !important;
        }

        /* 4. Hide all UI noise */
        footer,
        [data-starlight-pagination],
        h1,
        .page-title,
        .right-sidebar-container,
        aside,
        .sidebar {
            display: none !important;
        }

        /* If :has is supported, hide the title container specifically */
        .content-panel:has(h1) {
            display: none !important;
        }

        /* 5. Force Tutorial Workspace to fill the viewport */
        .not-content {
            flex: 1 !important;
            display: flex !important;
            flex-direction: column !important;
            width: 100% !important;
            height: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
            overflow: hidden !important;
        }

        /* Ensure variables are defined */
        :root {
            --sl-nav-height: 4rem;
            --sl-content-width: 100% !important;
            --sl-sidebar-width: 0rem !important;
        }

        /* 6. Fix Header Grid/Alignment */
        @media (min-width: 50rem) {
            .header {
                /* Use auto 1fr auto to match default docs layout */
                grid-template-columns: auto 1fr auto !important;
                column-gap: var(--sl-nav-gap);
            }
            .header > .title-wrapper {
                /* Title only takes necessary space */
                width: fit-content !important;
                min-width: 0 !important;
            }
            .header > div:nth-child(2) {
                /* Search container fills middle and centers content */
                display: flex !important;
                justify-content: center !important;
                width: 100% !important;
            }
        }
    </style>

    <div class="not-content h-[calc(100vh-var(--sl-nav-height))] w-full overflow-hidden">
        <TutorialWorkspace
            client:only="react"
            initialSlug={slug}
            allSteps={allSteps}
        />
    </div>
</StarlightPage>
