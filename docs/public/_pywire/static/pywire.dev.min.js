/* PyWire Client dev v0.1.10-dev0 - https://github.com/pywire/pywire */
"use strict";var PyWire=(()=>{var ae=Object.defineProperty;var et=Object.getOwnPropertyDescriptor;var tt=Object.getOwnPropertyNames;var rt=Object.prototype.hasOwnProperty;var it=(n,e,t)=>e in n?ae(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var nt=(n,e)=>{for(var t in e)ae(n,t,{get:e[t],enumerable:!0})},st=(n,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of tt(e))!rt.call(n,i)&&i!==t&&ae(n,i,{get:()=>e[i],enumerable:!(r=et(e,i))||r.enumerable});return n};var ot=n=>st(ae({},"__esModule",{value:!0}),n);var l=(n,e,t)=>(it(n,typeof e!="symbol"?e+"":e,t),t);var Gt={};nt(Gt,{DOMUpdater:()=>E,ErrorTraceHandler:()=>X,HTTPTransport:()=>z,PyWireApp:()=>K,PyWireDevApp:()=>G,StatusOverlay:()=>V,TransportManager:()=>O,WebSocketTransport:()=>F,WebTransportTransport:()=>L,app:()=>Le});var I=class{constructor(){this.messageHandlers=[];this.statusHandlers=[];this.connected=!1}onMessage(e){this.messageHandlers.push(e)}onStatusChange(e){this.statusHandlers.push(e)}isConnected(){return this.connected}notifyHandlers(e){for(let t of this.messageHandlers)try{t(e)}catch(r){console.error("PyWire: Error in message handler",r)}}notifyStatus(e){if(this.connected!==e){this.connected=e;for(let t of this.statusHandlers)try{t(e)}catch(r){console.error("PyWire: Error in status handler",r)}}}};var Ue=class{constructor(e=!1){this.debug=e}log(...e){this.debug&&console.log(...e)}warn(...e){this.debug&&console.warn(...e)}error(...e){console.error(...e)}info(...e){this.debug&&console.info(...e)}setDebug(e){this.debug=e}},c=new Ue;var L=class n extends I{constructor(t){super();this.name="WebTransport";this.transport=null;this.writer=null;this.encoder=new TextEncoder;this.decoder=new TextDecoder;this.url=t||this.getDefaultUrl()}getDefaultUrl(){return`https://${window.location.host}/_pywire/webtransport`}static isSupported(){return typeof WebTransport<"u"}async connect(){if(!n.isSupported())throw new Error("WebTransport not supported in this browser");try{let t={},r=window.PYWIRE_CERT_HASH;r&&Array.isArray(r)&&(t.serverCertificateHashes=[{algorithm:"sha-256",value:new Uint8Array(r).buffer}],c.log("PyWire: Using explicit certificate hash for WebTransport")),this.transport=new WebTransport(this.url,t),await this.transport.ready,c.log("PyWire: WebTransport ready"),this.connected=!0,this.startReading()}catch(t){throw this.handleDisconnect(),t}}async startReading(){if(!this.transport)return;let t=this.transport.incomingBidirectionalStreams.getReader();try{for(;;){let{value:r,done:i}=await t.read();if(i)break;this.handleStream(r)}}catch(r){this.connected&&(c.error("PyWire: WebTransport read error",r),this.handleDisconnect())}}async handleStream(t){let r=t.readable.getReader();try{for(;;){let{value:i,done:s}=await r.read();if(s)break;if(i){let o=this.decoder.decode(i);try{let a=JSON.parse(o);this.notifyHandlers(a)}catch(a){c.error("PyWire: Error parsing WebTransport message",a)}}}}catch(i){c.error("PyWire: Stream read error",i)}}async send(t){if(!this.transport||!this.connected){c.warn("PyWire: Cannot send message, WebTransport not connected");return}try{let r=await this.transport.createBidirectionalStream(),i=r.writable.getWriter(),s=this.encoder.encode(JSON.stringify(t));await i.write(s),await i.close(),this.handleStream(r)}catch(r){c.error("PyWire: WebTransport send error",r)}}disconnect(){this.transport&&(this.transport.close(),this.transport=null),this.writer=null,this.connected=!1}handleDisconnect(){this.connected=!1,this.transport=null,this.writer=null}};function Re(n){let e=n.length,t=0,r=0;for(;r<e;){let i=n.charCodeAt(r++);if(i&4294967168)if(!(i&4294965248))t+=2;else{if(i>=55296&&i<=56319&&r<e){let s=n.charCodeAt(r);(s&64512)===56320&&(++r,i=((i&1023)<<10)+(s&1023)+65536)}i&4294901760?t+=4:t+=3}else{t++;continue}}return t}function at(n,e,t){let r=n.length,i=t,s=0;for(;s<r;){let o=n.charCodeAt(s++);if(o&4294967168)if(!(o&4294965248))e[i++]=o>>6&31|192;else{if(o>=55296&&o<=56319&&s<r){let a=n.charCodeAt(s);(a&64512)===56320&&(++s,o=((o&1023)<<10)+(a&1023)+65536)}o&4294901760?(e[i++]=o>>18&7|240,e[i++]=o>>12&63|128,e[i++]=o>>6&63|128):(e[i++]=o>>12&15|224,e[i++]=o>>6&63|128)}else{e[i++]=o;continue}e[i++]=o&63|128}}var ct=new TextEncoder,lt=50;function dt(n,e,t){ct.encodeInto(n,e.subarray(t))}function $e(n,e,t){n.length>lt?dt(n,e,t):at(n,e,t)}var ht=4096;function Ae(n,e,t){let r=e,i=r+t,s=[],o="";for(;r<i;){let a=n[r++];if(!(a&128))s.push(a);else if((a&224)===192){let d=n[r++]&63;s.push((a&31)<<6|d)}else if((a&240)===224){let d=n[r++]&63,g=n[r++]&63;s.push((a&31)<<12|d<<6|g)}else if((a&248)===240){let d=n[r++]&63,g=n[r++]&63,w=n[r++]&63,m=(a&7)<<18|d<<12|g<<6|w;m>65535&&(m-=65536,s.push(m>>>10&1023|55296),m=56320|m&1023),s.push(m)}else s.push(a);s.length>=ht&&(o+=String.fromCharCode(...s),s.length=0)}return s.length>0&&(o+=String.fromCharCode(...s)),o}var ft=new TextDecoder,ut=200;function pt(n,e,t){let r=n.subarray(e,e+t);return ft.decode(r)}function Ne(n,e,t){return t>ut?pt(n,e,t):Ae(n,e,t)}var W=class{constructor(e,t){l(this,"type");l(this,"data");this.type=e,this.data=t}};var v=class n extends Error{constructor(e){super(e);let t=Object.create(n.prototype);Object.setPrototypeOf(this,t),Object.defineProperty(this,"name",{configurable:!0,enumerable:!1,value:n.name})}};function _e(n,e,t){let r=t/4294967296,i=t;n.setUint32(e,r),n.setUint32(e+4,i)}function ce(n,e,t){let r=Math.floor(t/4294967296),i=t;n.setUint32(e,r),n.setUint32(e+4,i)}function le(n,e){let t=n.getInt32(e),r=n.getUint32(e+4);return t*4294967296+r}function Fe(n,e){let t=n.getUint32(e),r=n.getUint32(e+4);return t*4294967296+r}var gt=-1,mt=4294967296-1,yt=17179869184-1;function wt({sec:n,nsec:e}){if(n>=0&&e>=0&&n<=yt)if(e===0&&n<=mt){let t=new Uint8Array(4);return new DataView(t.buffer).setUint32(0,n),t}else{let t=n/4294967296,r=n&4294967295,i=new Uint8Array(8),s=new DataView(i.buffer);return s.setUint32(0,e<<2|t&3),s.setUint32(4,r),i}else{let t=new Uint8Array(12),r=new DataView(t.buffer);return r.setUint32(0,e),ce(r,4,n),t}}function xt(n){let e=n.getTime(),t=Math.floor(e/1e3),r=(e-t*1e3)*1e6,i=Math.floor(r/1e9);return{sec:t+i,nsec:r-i*1e9}}function vt(n){if(n instanceof Date){let e=xt(n);return wt(e)}else return null}function bt(n){let e=new DataView(n.buffer,n.byteOffset,n.byteLength);switch(n.byteLength){case 4:return{sec:e.getUint32(0),nsec:0};case 8:{let t=e.getUint32(0),r=e.getUint32(4),i=(t&3)*4294967296+r,s=t>>>2;return{sec:i,nsec:s}}case 12:{let t=le(e,4),r=e.getUint32(0);return{sec:t,nsec:r}}default:throw new v(`Unrecognized data size for timestamp (expected 4, 8, or 12): ${n.length}`)}}function St(n){let e=bt(n);return new Date(e.sec*1e3+e.nsec/1e6)}var ze={type:gt,encode:vt,decode:St};var de=class de{constructor(){l(this,"__brand");l(this,"builtInEncoders",[]);l(this,"builtInDecoders",[]);l(this,"encoders",[]);l(this,"decoders",[]);this.register(ze)}register({type:e,encode:t,decode:r}){if(e>=0)this.encoders[e]=t,this.decoders[e]=r;else{let i=-1-e;this.builtInEncoders[i]=t,this.builtInDecoders[i]=r}}tryToEncode(e,t){for(let r=0;r<this.builtInEncoders.length;r++){let i=this.builtInEncoders[r];if(i!=null){let s=i(e,t);if(s!=null){let o=-1-r;return new W(o,s)}}}for(let r=0;r<this.encoders.length;r++){let i=this.encoders[r];if(i!=null){let s=i(e,t);if(s!=null){let o=r;return new W(o,s)}}}return e instanceof W?e:null}decode(e,t,r){let i=t<0?this.builtInDecoders[-1-t]:this.decoders[t];return i?i(e,t,r):new W(t,e)}};l(de,"defaultCodec",new de);var N=de;function Tt(n){return n instanceof ArrayBuffer||typeof SharedArrayBuffer<"u"&&n instanceof SharedArrayBuffer}function q(n){return n instanceof Uint8Array?n:ArrayBuffer.isView(n)?new Uint8Array(n.buffer,n.byteOffset,n.byteLength):Tt(n)?new Uint8Array(n):Uint8Array.from(n)}var Et=100,Ut=2048,he=class n{constructor(e){l(this,"extensionCodec");l(this,"context");l(this,"useBigInt64");l(this,"maxDepth");l(this,"initialBufferSize");l(this,"sortKeys");l(this,"forceFloat32");l(this,"ignoreUndefined");l(this,"forceIntegerToFloat");l(this,"pos");l(this,"view");l(this,"bytes");l(this,"entered",!1);this.extensionCodec=e?.extensionCodec??N.defaultCodec,this.context=e?.context,this.useBigInt64=e?.useBigInt64??!1,this.maxDepth=e?.maxDepth??Et,this.initialBufferSize=e?.initialBufferSize??Ut,this.sortKeys=e?.sortKeys??!1,this.forceFloat32=e?.forceFloat32??!1,this.ignoreUndefined=e?.ignoreUndefined??!1,this.forceIntegerToFloat=e?.forceIntegerToFloat??!1,this.pos=0,this.view=new DataView(new ArrayBuffer(this.initialBufferSize)),this.bytes=new Uint8Array(this.view.buffer)}clone(){return new n({extensionCodec:this.extensionCodec,context:this.context,useBigInt64:this.useBigInt64,maxDepth:this.maxDepth,initialBufferSize:this.initialBufferSize,sortKeys:this.sortKeys,forceFloat32:this.forceFloat32,ignoreUndefined:this.ignoreUndefined,forceIntegerToFloat:this.forceIntegerToFloat})}reinitializeState(){this.pos=0}encodeSharedRef(e){if(this.entered)return this.clone().encodeSharedRef(e);try{return this.entered=!0,this.reinitializeState(),this.doEncode(e,1),this.bytes.subarray(0,this.pos)}finally{this.entered=!1}}encode(e){if(this.entered)return this.clone().encode(e);try{return this.entered=!0,this.reinitializeState(),this.doEncode(e,1),this.bytes.slice(0,this.pos)}finally{this.entered=!1}}doEncode(e,t){if(t>this.maxDepth)throw new Error(`Too deep objects in depth ${t}`);e==null?this.encodeNil():typeof e=="boolean"?this.encodeBoolean(e):typeof e=="number"?this.forceIntegerToFloat?this.encodeNumberAsFloat(e):this.encodeNumber(e):typeof e=="string"?this.encodeString(e):this.useBigInt64&&typeof e=="bigint"?this.encodeBigInt64(e):this.encodeObject(e,t)}ensureBufferSizeToWrite(e){let t=this.pos+e;this.view.byteLength<t&&this.resizeBuffer(t*2)}resizeBuffer(e){let t=new ArrayBuffer(e),r=new Uint8Array(t),i=new DataView(t);r.set(this.bytes),this.view=i,this.bytes=r}encodeNil(){this.writeU8(192)}encodeBoolean(e){e===!1?this.writeU8(194):this.writeU8(195)}encodeNumber(e){!this.forceIntegerToFloat&&Number.isSafeInteger(e)?e>=0?e<128?this.writeU8(e):e<256?(this.writeU8(204),this.writeU8(e)):e<65536?(this.writeU8(205),this.writeU16(e)):e<4294967296?(this.writeU8(206),this.writeU32(e)):this.useBigInt64?this.encodeNumberAsFloat(e):(this.writeU8(207),this.writeU64(e)):e>=-32?this.writeU8(224|e+32):e>=-128?(this.writeU8(208),this.writeI8(e)):e>=-32768?(this.writeU8(209),this.writeI16(e)):e>=-2147483648?(this.writeU8(210),this.writeI32(e)):this.useBigInt64?this.encodeNumberAsFloat(e):(this.writeU8(211),this.writeI64(e)):this.encodeNumberAsFloat(e)}encodeNumberAsFloat(e){this.forceFloat32?(this.writeU8(202),this.writeF32(e)):(this.writeU8(203),this.writeF64(e))}encodeBigInt64(e){e>=BigInt(0)?(this.writeU8(207),this.writeBigUint64(e)):(this.writeU8(211),this.writeBigInt64(e))}writeStringHeader(e){if(e<32)this.writeU8(160+e);else if(e<256)this.writeU8(217),this.writeU8(e);else if(e<65536)this.writeU8(218),this.writeU16(e);else if(e<4294967296)this.writeU8(219),this.writeU32(e);else throw new Error(`Too long string: ${e} bytes in UTF-8`)}encodeString(e){let r=Re(e);this.ensureBufferSizeToWrite(5+r),this.writeStringHeader(r),$e(e,this.bytes,this.pos),this.pos+=r}encodeObject(e,t){let r=this.extensionCodec.tryToEncode(e,this.context);if(r!=null)this.encodeExtension(r);else if(Array.isArray(e))this.encodeArray(e,t);else if(ArrayBuffer.isView(e))this.encodeBinary(e);else if(typeof e=="object")this.encodeMap(e,t);else throw new Error(`Unrecognized object: ${Object.prototype.toString.apply(e)}`)}encodeBinary(e){let t=e.byteLength;if(t<256)this.writeU8(196),this.writeU8(t);else if(t<65536)this.writeU8(197),this.writeU16(t);else if(t<4294967296)this.writeU8(198),this.writeU32(t);else throw new Error(`Too large binary: ${t}`);let r=q(e);this.writeU8a(r)}encodeArray(e,t){let r=e.length;if(r<16)this.writeU8(144+r);else if(r<65536)this.writeU8(220),this.writeU16(r);else if(r<4294967296)this.writeU8(221),this.writeU32(r);else throw new Error(`Too large array: ${r}`);for(let i of e)this.doEncode(i,t+1)}countWithoutUndefined(e,t){let r=0;for(let i of t)e[i]!==void 0&&r++;return r}encodeMap(e,t){let r=Object.keys(e);this.sortKeys&&r.sort();let i=this.ignoreUndefined?this.countWithoutUndefined(e,r):r.length;if(i<16)this.writeU8(128+i);else if(i<65536)this.writeU8(222),this.writeU16(i);else if(i<4294967296)this.writeU8(223),this.writeU32(i);else throw new Error(`Too large map object: ${i}`);for(let s of r){let o=e[s];this.ignoreUndefined&&o===void 0||(this.encodeString(s),this.doEncode(o,t+1))}}encodeExtension(e){if(typeof e.data=="function"){let r=e.data(this.pos+6),i=r.length;if(i>=4294967296)throw new Error(`Too large extension object: ${i}`);this.writeU8(201),this.writeU32(i),this.writeI8(e.type),this.writeU8a(r);return}let t=e.data.length;if(t===1)this.writeU8(212);else if(t===2)this.writeU8(213);else if(t===4)this.writeU8(214);else if(t===8)this.writeU8(215);else if(t===16)this.writeU8(216);else if(t<256)this.writeU8(199),this.writeU8(t);else if(t<65536)this.writeU8(200),this.writeU16(t);else if(t<4294967296)this.writeU8(201),this.writeU32(t);else throw new Error(`Too large extension object: ${t}`);this.writeI8(e.type),this.writeU8a(e.data)}writeU8(e){this.ensureBufferSizeToWrite(1),this.view.setUint8(this.pos,e),this.pos++}writeU8a(e){let t=e.length;this.ensureBufferSizeToWrite(t),this.bytes.set(e,this.pos),this.pos+=t}writeI8(e){this.ensureBufferSizeToWrite(1),this.view.setInt8(this.pos,e),this.pos++}writeU16(e){this.ensureBufferSizeToWrite(2),this.view.setUint16(this.pos,e),this.pos+=2}writeI16(e){this.ensureBufferSizeToWrite(2),this.view.setInt16(this.pos,e),this.pos+=2}writeU32(e){this.ensureBufferSizeToWrite(4),this.view.setUint32(this.pos,e),this.pos+=4}writeI32(e){this.ensureBufferSizeToWrite(4),this.view.setInt32(this.pos,e),this.pos+=4}writeF32(e){this.ensureBufferSizeToWrite(4),this.view.setFloat32(this.pos,e),this.pos+=4}writeF64(e){this.ensureBufferSizeToWrite(8),this.view.setFloat64(this.pos,e),this.pos+=8}writeU64(e){this.ensureBufferSizeToWrite(8),_e(this.view,this.pos,e),this.pos+=8}writeI64(e){this.ensureBufferSizeToWrite(8),ce(this.view,this.pos,e),this.pos+=8}writeBigUint64(e){this.ensureBufferSizeToWrite(8),this.view.setBigUint64(this.pos,e),this.pos+=8}writeBigInt64(e){this.ensureBufferSizeToWrite(8),this.view.setBigInt64(this.pos,e),this.pos+=8}};function _(n,e){return new he(e).encodeSharedRef(n)}function fe(n){return`${n<0?"-":""}0x${Math.abs(n).toString(16).padStart(2,"0")}`}var At=16,kt=16,ue=class{constructor(e=At,t=kt){l(this,"hit",0);l(this,"miss",0);l(this,"caches");l(this,"maxKeyLength");l(this,"maxLengthPerKey");this.maxKeyLength=e,this.maxLengthPerKey=t,this.caches=[];for(let r=0;r<this.maxKeyLength;r++)this.caches.push([])}canBeCached(e){return e>0&&e<=this.maxKeyLength}find(e,t,r){let i=this.caches[r-1];e:for(let s of i){let o=s.bytes;for(let a=0;a<r;a++)if(o[a]!==e[t+a])continue e;return s.str}return null}store(e,t){let r=this.caches[e.length-1],i={bytes:e,str:t};r.length>=this.maxLengthPerKey?r[Math.random()*r.length|0]=i:r.push(i)}decode(e,t,r){let i=this.find(e,t,r);if(i!=null)return this.hit++,i;this.miss++;let s=Ae(e,t,r),o=Uint8Array.prototype.slice.call(e,t,t+r);return this.store(o,s),s}};var ke="array",j="map_key",Ke="map_value",Mt=n=>{if(typeof n=="string"||typeof n=="number")return n;throw new v("The type of key must be string or number but "+typeof n)},Me=class{constructor(){l(this,"stack",[]);l(this,"stackHeadPosition",-1)}get length(){return this.stackHeadPosition+1}top(){return this.stack[this.stackHeadPosition]}pushArrayState(e){let t=this.getUninitializedStateFromPool();t.type=ke,t.position=0,t.size=e,t.array=new Array(e)}pushMapState(e){let t=this.getUninitializedStateFromPool();t.type=j,t.readCount=0,t.size=e,t.map={}}getUninitializedStateFromPool(){if(this.stackHeadPosition++,this.stackHeadPosition===this.stack.length){let e={type:void 0,size:0,array:void 0,position:0,readCount:0,map:void 0,key:null};this.stack.push(e)}return this.stack[this.stackHeadPosition]}release(e){if(this.stack[this.stackHeadPosition]!==e)throw new Error("Invalid stack state. Released state is not on top of the stack.");if(e.type===ke){let r=e;r.size=0,r.array=void 0,r.position=0,r.type=void 0}if(e.type===j||e.type===Ke){let r=e;r.size=0,r.map=void 0,r.readCount=0,r.type=void 0}this.stackHeadPosition--}reset(){this.stack.length=0,this.stackHeadPosition=-1}},Q=-1,Pe=new DataView(new ArrayBuffer(0)),Pt=new Uint8Array(Pe.buffer);try{Pe.getInt8(0)}catch(n){if(!(n instanceof RangeError))throw new Error("This module is not supported in the current JavaScript engine because DataView does not throw RangeError on out-of-bounds access")}var Oe=new RangeError("Insufficient data"),Bt=new ue,pe=class n{constructor(e){l(this,"extensionCodec");l(this,"context");l(this,"useBigInt64");l(this,"rawStrings");l(this,"maxStrLength");l(this,"maxBinLength");l(this,"maxArrayLength");l(this,"maxMapLength");l(this,"maxExtLength");l(this,"keyDecoder");l(this,"mapKeyConverter");l(this,"totalPos",0);l(this,"pos",0);l(this,"view",Pe);l(this,"bytes",Pt);l(this,"headByte",Q);l(this,"stack",new Me);l(this,"entered",!1);this.extensionCodec=e?.extensionCodec??N.defaultCodec,this.context=e?.context,this.useBigInt64=e?.useBigInt64??!1,this.rawStrings=e?.rawStrings??!1,this.maxStrLength=e?.maxStrLength??4294967295,this.maxBinLength=e?.maxBinLength??4294967295,this.maxArrayLength=e?.maxArrayLength??4294967295,this.maxMapLength=e?.maxMapLength??4294967295,this.maxExtLength=e?.maxExtLength??4294967295,this.keyDecoder=e?.keyDecoder!==void 0?e.keyDecoder:Bt,this.mapKeyConverter=e?.mapKeyConverter??Mt}clone(){return new n({extensionCodec:this.extensionCodec,context:this.context,useBigInt64:this.useBigInt64,rawStrings:this.rawStrings,maxStrLength:this.maxStrLength,maxBinLength:this.maxBinLength,maxArrayLength:this.maxArrayLength,maxMapLength:this.maxMapLength,maxExtLength:this.maxExtLength,keyDecoder:this.keyDecoder})}reinitializeState(){this.totalPos=0,this.headByte=Q,this.stack.reset()}setBuffer(e){let t=q(e);this.bytes=t,this.view=new DataView(t.buffer,t.byteOffset,t.byteLength),this.pos=0}appendBuffer(e){if(this.headByte===Q&&!this.hasRemaining(1))this.setBuffer(e);else{let t=this.bytes.subarray(this.pos),r=q(e),i=new Uint8Array(t.length+r.length);i.set(t),i.set(r,t.length),this.setBuffer(i)}}hasRemaining(e){return this.view.byteLength-this.pos>=e}createExtraByteError(e){let{view:t,pos:r}=this;return new RangeError(`Extra ${t.byteLength-r} of ${t.byteLength} byte(s) found at buffer[${e}]`)}decode(e){if(this.entered)return this.clone().decode(e);try{this.entered=!0,this.reinitializeState(),this.setBuffer(e);let t=this.doDecodeSync();if(this.hasRemaining(1))throw this.createExtraByteError(this.pos);return t}finally{this.entered=!1}}*decodeMulti(e){if(this.entered){yield*this.clone().decodeMulti(e);return}try{for(this.entered=!0,this.reinitializeState(),this.setBuffer(e);this.hasRemaining(1);)yield this.doDecodeSync()}finally{this.entered=!1}}async decodeAsync(e){if(this.entered)return this.clone().decodeAsync(e);try{this.entered=!0;let t=!1,r;for await(let a of e){if(t)throw this.entered=!1,this.createExtraByteError(this.totalPos);this.appendBuffer(a);try{r=this.doDecodeSync(),t=!0}catch(d){if(!(d instanceof RangeError))throw d}this.totalPos+=this.pos}if(t){if(this.hasRemaining(1))throw this.createExtraByteError(this.totalPos);return r}let{headByte:i,pos:s,totalPos:o}=this;throw new RangeError(`Insufficient data in parsing ${fe(i)} at ${o} (${s} in the current buffer)`)}finally{this.entered=!1}}decodeArrayStream(e){return this.decodeMultiAsync(e,!0)}decodeStream(e){return this.decodeMultiAsync(e,!1)}async*decodeMultiAsync(e,t){if(this.entered){yield*this.clone().decodeMultiAsync(e,t);return}try{this.entered=!0;let r=t,i=-1;for await(let s of e){if(t&&i===0)throw this.createExtraByteError(this.totalPos);this.appendBuffer(s),r&&(i=this.readArraySize(),r=!1,this.complete());try{for(;yield this.doDecodeSync(),--i!==0;);}catch(o){if(!(o instanceof RangeError))throw o}this.totalPos+=this.pos}}finally{this.entered=!1}}doDecodeSync(){e:for(;;){let e=this.readHeadByte(),t;if(e>=224)t=e-256;else if(e<192)if(e<128)t=e;else if(e<144){let i=e-128;if(i!==0){this.pushMapState(i),this.complete();continue e}else t={}}else if(e<160){let i=e-144;if(i!==0){this.pushArrayState(i),this.complete();continue e}else t=[]}else{let i=e-160;t=this.decodeString(i,0)}else if(e===192)t=null;else if(e===194)t=!1;else if(e===195)t=!0;else if(e===202)t=this.readF32();else if(e===203)t=this.readF64();else if(e===204)t=this.readU8();else if(e===205)t=this.readU16();else if(e===206)t=this.readU32();else if(e===207)this.useBigInt64?t=this.readU64AsBigInt():t=this.readU64();else if(e===208)t=this.readI8();else if(e===209)t=this.readI16();else if(e===210)t=this.readI32();else if(e===211)this.useBigInt64?t=this.readI64AsBigInt():t=this.readI64();else if(e===217){let i=this.lookU8();t=this.decodeString(i,1)}else if(e===218){let i=this.lookU16();t=this.decodeString(i,2)}else if(e===219){let i=this.lookU32();t=this.decodeString(i,4)}else if(e===220){let i=this.readU16();if(i!==0){this.pushArrayState(i),this.complete();continue e}else t=[]}else if(e===221){let i=this.readU32();if(i!==0){this.pushArrayState(i),this.complete();continue e}else t=[]}else if(e===222){let i=this.readU16();if(i!==0){this.pushMapState(i),this.complete();continue e}else t={}}else if(e===223){let i=this.readU32();if(i!==0){this.pushMapState(i),this.complete();continue e}else t={}}else if(e===196){let i=this.lookU8();t=this.decodeBinary(i,1)}else if(e===197){let i=this.lookU16();t=this.decodeBinary(i,2)}else if(e===198){let i=this.lookU32();t=this.decodeBinary(i,4)}else if(e===212)t=this.decodeExtension(1,0);else if(e===213)t=this.decodeExtension(2,0);else if(e===214)t=this.decodeExtension(4,0);else if(e===215)t=this.decodeExtension(8,0);else if(e===216)t=this.decodeExtension(16,0);else if(e===199){let i=this.lookU8();t=this.decodeExtension(i,1)}else if(e===200){let i=this.lookU16();t=this.decodeExtension(i,2)}else if(e===201){let i=this.lookU32();t=this.decodeExtension(i,4)}else throw new v(`Unrecognized type byte: ${fe(e)}`);this.complete();let r=this.stack;for(;r.length>0;){let i=r.top();if(i.type===ke)if(i.array[i.position]=t,i.position++,i.position===i.size)t=i.array,r.release(i);else continue e;else if(i.type===j){if(t==="__proto__")throw new v("The key __proto__ is not allowed");i.key=this.mapKeyConverter(t),i.type=Ke;continue e}else if(i.map[i.key]=t,i.readCount++,i.readCount===i.size)t=i.map,r.release(i);else{i.key=null,i.type=j;continue e}}return t}}readHeadByte(){return this.headByte===Q&&(this.headByte=this.readU8()),this.headByte}complete(){this.headByte=Q}readArraySize(){let e=this.readHeadByte();switch(e){case 220:return this.readU16();case 221:return this.readU32();default:{if(e<160)return e-144;throw new v(`Unrecognized array type byte: ${fe(e)}`)}}}pushMapState(e){if(e>this.maxMapLength)throw new v(`Max length exceeded: map length (${e}) > maxMapLengthLength (${this.maxMapLength})`);this.stack.pushMapState(e)}pushArrayState(e){if(e>this.maxArrayLength)throw new v(`Max length exceeded: array length (${e}) > maxArrayLength (${this.maxArrayLength})`);this.stack.pushArrayState(e)}decodeString(e,t){return!this.rawStrings||this.stateIsMapKey()?this.decodeUtf8String(e,t):this.decodeBinary(e,t)}decodeUtf8String(e,t){if(e>this.maxStrLength)throw new v(`Max length exceeded: UTF-8 byte length (${e}) > maxStrLength (${this.maxStrLength})`);if(this.bytes.byteLength<this.pos+t+e)throw Oe;let r=this.pos+t,i;return this.stateIsMapKey()&&this.keyDecoder?.canBeCached(e)?i=this.keyDecoder.decode(this.bytes,r,e):i=Ne(this.bytes,r,e),this.pos+=t+e,i}stateIsMapKey(){return this.stack.length>0?this.stack.top().type===j:!1}decodeBinary(e,t){if(e>this.maxBinLength)throw new v(`Max length exceeded: bin length (${e}) > maxBinLength (${this.maxBinLength})`);if(!this.hasRemaining(e+t))throw Oe;let r=this.pos+t,i=this.bytes.subarray(r,r+e);return this.pos+=t+e,i}decodeExtension(e,t){if(e>this.maxExtLength)throw new v(`Max length exceeded: ext length (${e}) > maxExtLength (${this.maxExtLength})`);let r=this.view.getInt8(this.pos+t),i=this.decodeBinary(e,t+1);return this.extensionCodec.decode(i,r,this.context)}lookU8(){return this.view.getUint8(this.pos)}lookU16(){return this.view.getUint16(this.pos)}lookU32(){return this.view.getUint32(this.pos)}readU8(){let e=this.view.getUint8(this.pos);return this.pos++,e}readI8(){let e=this.view.getInt8(this.pos);return this.pos++,e}readU16(){let e=this.view.getUint16(this.pos);return this.pos+=2,e}readI16(){let e=this.view.getInt16(this.pos);return this.pos+=2,e}readU32(){let e=this.view.getUint32(this.pos);return this.pos+=4,e}readI32(){let e=this.view.getInt32(this.pos);return this.pos+=4,e}readU64(){let e=Fe(this.view,this.pos);return this.pos+=8,e}readI64(){let e=le(this.view,this.pos);return this.pos+=8,e}readU64AsBigInt(){let e=this.view.getBigUint64(this.pos);return this.pos+=8,e}readI64AsBigInt(){let e=this.view.getBigInt64(this.pos);return this.pos+=8,e}readF32(){let e=this.view.getFloat32(this.pos);return this.pos+=4,e}readF64(){let e=this.view.getFloat64(this.pos);return this.pos+=8,e}};function D(n,e){return new pe(e).decode(n)}var ge=!1,F=class extends I{constructor(t){super();this.name="WebSocket";this.socket=null;this.reconnectAttempts=0;this.maxReconnectDelay=5e3;this.shouldReconnect=!0;this.url=t||this.getDefaultUrl()}getDefaultUrl(){return`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/_pywire/ws`}connect(){return new Promise((t,r)=>{try{ge&&c.log(`PyWire: Connecting WebSocket to ${this.url}`),this.socket=new WebSocket(this.url),this.socket.binaryType="arraybuffer",this.socket.onopen=()=>{ge&&c.log("PyWire: WebSocket connected"),this.notifyStatus(!0),this.reconnectAttempts=0,t()},this.socket.onmessage=i=>{try{let s=D(i.data);this.notifyHandlers(s)}catch(s){c.error("PyWire: Error parsing WebSocket message",s)}},this.socket.onclose=()=>{ge&&c.log("PyWire: WebSocket disconnected"),this.notifyStatus(!1),this.shouldReconnect&&this.scheduleReconnect()},this.socket.onerror=i=>{c.error("PyWire: WebSocket error",i),this.connected||r(new Error("WebSocket connection failed"))}}catch(i){r(i)}})}send(t){this.socket&&this.socket.readyState===WebSocket.OPEN?this.socket.send(_(t)):c.warn("PyWire: Cannot send message, WebSocket not open")}disconnect(){this.shouldReconnect=!1,this.socket&&(this.socket.close(),this.socket=null),this.notifyStatus(!1)}scheduleReconnect(){let t=Math.min(1e3*Math.pow(2,this.reconnectAttempts),this.maxReconnectDelay);ge&&c.log(`PyWire: Reconnecting in ${t}ms...`),setTimeout(()=>{this.reconnectAttempts++,this.connect().catch(()=>{})},t)}};var Be=!1,z=class extends I{constructor(t){super();this.name="HTTP";this.polling=!1;this.pollAbortController=null;this.sessionId=null;this.baseUrl=t||`${window.location.origin}/_pywire`}async connect(){try{Be&&c.log(`PyWire: Connecting HTTP transport to ${this.baseUrl}`);let t=await fetch(`${this.baseUrl}/session`,{method:"POST",headers:{"Content-Type":"application/x-msgpack",Accept:"application/x-msgpack"},body:_({path:window.location.pathname+window.location.search})});if(!t.ok)throw new Error(`HTTP session init failed: ${t.status}`);let r=await t.arrayBuffer(),i=D(r);this.sessionId=i.sessionId,i.version&&this.notifyHandlers({type:"init",version:i.version}),Be&&c.log("PyWire: HTTP transport connected"),this.notifyStatus(!0),this.startPolling()}catch(t){throw c.error("PyWire: HTTP transport connection failed",t),t}}async startPolling(){if(!this.polling)for(this.polling=!0;this.polling&&this.connected;)try{this.pollAbortController=new AbortController;let t=await fetch(`${this.baseUrl}/poll?session=${this.sessionId}`,{method:"GET",signal:this.pollAbortController.signal,headers:{Accept:"application/x-msgpack"}});if(!t.ok){if(t.status===404){Be&&c.warn("PyWire: HTTP session expired, reconnecting..."),this.notifyStatus(!1),await this.connect();return}throw new Error(`Poll failed: ${t.status}`)}let r=await t.arrayBuffer(),i=D(r);for(let s of i)this.notifyHandlers(s)}catch(t){if(t instanceof Error&&t.name==="AbortError")break;c.error("PyWire: HTTP poll error",t),await this.sleep(1e3)}}async send(t){if(!this.connected||!this.sessionId){c.warn("PyWire: Cannot send message, HTTP transport not connected");return}try{let r=await fetch(`${this.baseUrl}/event`,{method:"POST",headers:{"Content-Type":"application/x-msgpack",Accept:"application/x-msgpack","X-PyWire-Session":this.sessionId},body:_(t)});if(!r.ok)throw new Error(`Event send failed: ${r.status}`);let i=await r.arrayBuffer(),s=D(i);this.notifyHandlers(s)}catch(r){c.error("PyWire: HTTP send error",r)}}disconnect(){this.polling=!1,this.notifyStatus(!1),this.pollAbortController&&(this.pollAbortController.abort(),this.pollAbortController=null),this.sessionId=null}sleep(t){return new Promise(r=>setTimeout(r,t))}};var It={enableWebTransport:!0,enableWebSocket:!0,enableHTTP:!0},O=class{constructor(e={}){this.transport=null;this.messageHandlers=[];this.statusHandlers=[];this.config={...It,...e}}async connect(){let e=this.getTransportPriority();for(let t of e)try{c.log(`PyWire: Trying ${t.name}...`),this.transport=new t;for(let r of this.messageHandlers)this.transport.onMessage(r);this.transport.onStatusChange(r=>{this.notifyStatusHandlers(r)}),await this.transport.connect(),c.log(`PyWire: Connected via ${this.transport.name}`);return}catch(r){c.warn(`PyWire: ${t.name} failed, trying next...`,r),this.transport=null}throw new Error("PyWire: All transports failed")}getTransportPriority(){let e=[];return this.config.enableWebTransport&&L.isSupported()&&window.location.protocol==="https:"&&e.push(L),this.config.enableWebSocket&&typeof WebSocket<"u"&&e.push(F),this.config.enableHTTP&&e.push(z),e}send(e){this.transport?this.transport.send(e):c.warn("PyWire: No active transport")}onMessage(e){this.messageHandlers.push(e),this.transport&&this.transport.onMessage(e)}onStatusChange(e){this.statusHandlers.push(e)}notifyStatusHandlers(e){for(let t of this.statusHandlers)t(e)}disconnect(){this.transport&&(this.transport.disconnect(),this.transport=null,this.notifyStatusHandlers(!1))}getActiveTransport(){return this.transport?.name||null}isConnected(){return this.transport?.isConnected()||!1}};var Ve="0.1.10-dev0";var Xe=11;function Lt(n,e){var t=e.attributes,r,i,s,o,a;if(!(e.nodeType===Xe||n.nodeType===Xe)){for(var d=t.length-1;d>=0;d--)r=t[d],i=r.name,s=r.namespaceURI,o=r.value,s?(i=r.localName||i,a=n.getAttributeNS(s,i),a!==o&&(r.prefix==="xmlns"&&(i=r.name),n.setAttributeNS(s,i,o))):(a=n.getAttribute(i),a!==o&&n.setAttribute(i,o));for(var g=n.attributes,w=g.length-1;w>=0;w--)r=g[w],i=r.name,s=r.namespaceURI,s?(i=r.localName||i,e.hasAttributeNS(s,i)||n.removeAttributeNS(s,i)):e.hasAttribute(i)||n.removeAttribute(i)}}var me,Wt="http://www.w3.org/1999/xhtml",b=typeof document>"u"?void 0:document,Dt=!!b&&"content"in b.createElement("template"),Ht=!!b&&b.createRange&&"createContextualFragment"in b.createRange();function Rt(n){var e=b.createElement("template");return e.innerHTML=n,e.content.childNodes[0]}function $t(n){me||(me=b.createRange(),me.selectNode(b.body));var e=me.createContextualFragment(n);return e.childNodes[0]}function Nt(n){var e=b.createElement("body");return e.innerHTML=n,e.childNodes[0]}function _t(n){return n=n.trim(),Dt?Rt(n):Ht?$t(n):Nt(n)}function ye(n,e){var t=n.nodeName,r=e.nodeName,i,s;return t===r?!0:(i=t.charCodeAt(0),s=r.charCodeAt(0),i<=90&&s>=97?t===r.toUpperCase():s<=90&&i>=97?r===t.toUpperCase():!1)}function Ft(n,e){return!e||e===Wt?b.createElement(n):b.createElementNS(e,n)}function zt(n,e){for(var t=n.firstChild;t;){var r=t.nextSibling;e.appendChild(t),t=r}return e}function Ie(n,e,t){n[t]!==e[t]&&(n[t]=e[t],n[t]?n.setAttribute(t,""):n.removeAttribute(t))}var Ge={OPTION:function(n,e){var t=n.parentNode;if(t){var r=t.nodeName.toUpperCase();r==="OPTGROUP"&&(t=t.parentNode,r=t&&t.nodeName.toUpperCase()),r==="SELECT"&&!t.hasAttribute("multiple")&&(n.hasAttribute("selected")&&!e.selected&&(n.setAttribute("selected","selected"),n.removeAttribute("selected")),t.selectedIndex=-1)}Ie(n,e,"selected")},INPUT:function(n,e){Ie(n,e,"checked"),Ie(n,e,"disabled"),n.value!==e.value&&(n.value=e.value),e.hasAttribute("value")||n.removeAttribute("value")},TEXTAREA:function(n,e){var t=e.value;n.value!==t&&(n.value=t);var r=n.firstChild;if(r){var i=r.nodeValue;if(i==t||!t&&i==n.placeholder)return;r.nodeValue=t}},SELECT:function(n,e){if(!e.hasAttribute("multiple")){for(var t=-1,r=0,i=n.firstChild,s,o;i;)if(o=i.nodeName&&i.nodeName.toUpperCase(),o==="OPTGROUP")s=i,i=s.firstChild,i||(i=s.nextSibling,s=null);else{if(o==="OPTION"){if(i.hasAttribute("selected")){t=r;break}r++}i=i.nextSibling,!i&&s&&(i=s.nextSibling,s=null)}n.selectedIndex=t}}},ee=1,Ye=11,Je=3,qe=8;function C(){}function Ot(n){if(n)return n.getAttribute&&n.getAttribute("id")||n.id}function Kt(n){return function(t,r,i){if(i||(i={}),typeof r=="string")if(t.nodeName==="#document"||t.nodeName==="HTML"||t.nodeName==="BODY"){var s=r;r=b.createElement("html"),r.innerHTML=s}else r=_t(r);else r.nodeType===Ye&&(r=r.firstElementChild);var o=i.getNodeKey||Ot,a=i.onBeforeNodeAdded||C,d=i.onNodeAdded||C,g=i.onBeforeElUpdated||C,w=i.onElUpdated||C,m=i.onBeforeNodeDiscarded||C,A=i.onNodeDiscarded||C,Y=i.onBeforeElChildrenUpdated||C,S=i.skipFromChildren||C,J=i.addChild||function(h,f){return h.appendChild(f)},H=i.childrenOnly===!0,T=Object.create(null),k=[];function M(h){k.push(h)}function We(h,f){if(h.nodeType===ee)for(var y=h.firstChild;y;){var u=void 0;f&&(u=o(y))?M(u):(A(y),y.firstChild&&We(y,f)),y=y.nextSibling}}function re(h,f,y){m(h)!==!1&&(f&&f.removeChild(h),A(h),We(h,y))}function ve(h){if(h.nodeType===ee||h.nodeType===Ye)for(var f=h.firstChild;f;){var y=o(f);y&&(T[y]=f),ve(f),f=f.nextSibling}}ve(t);function be(h){d(h);for(var f=h.firstChild;f;){var y=f.nextSibling,u=o(f);if(u){var p=T[u];p&&ye(f,p)?(f.parentNode.replaceChild(p,f),ie(p,f)):be(f)}else be(f);f=y}}function Ze(h,f,y){for(;f;){var u=f.nextSibling;(y=o(f))?M(y):re(f,h,!0),f=u}}function ie(h,f,y){var u=o(f);if(u&&delete T[u],!y){var p=g(h,f);if(p===!1||(p instanceof HTMLElement&&(h=p,ve(h)),n(h,f),w(h),Y(h,f)===!1))return}h.nodeName!=="TEXTAREA"?Qe(h,f):Ge.TEXTAREA(h,f)}function Qe(h,f){var y=S(h,f),u=f.firstChild,p=h.firstChild,R,U,$,se,P;e:for(;u;){for(se=u.nextSibling,R=o(u);!y&&p;){if($=p.nextSibling,u.isSameNode&&u.isSameNode(p)){u=se,p=$;continue e}U=o(p);var oe=p.nodeType,B=void 0;if(oe===u.nodeType&&(oe===ee?(R?R!==U&&((P=T[R])?$===P?B=!1:(h.insertBefore(P,p),U?M(U):re(p,h,!0),p=P,U=o(p)):B=!1):U&&(B=!1),B=B!==!1&&ye(p,u),B&&ie(p,u)):(oe===Je||oe==qe)&&(B=!0,p.nodeValue!==u.nodeValue&&(p.nodeValue=u.nodeValue))),B){u=se,p=$;continue e}U?M(U):re(p,h,!0),p=$}if(R&&(P=T[R])&&ye(P,u))y||J(h,P),ie(P,u);else{var Ee=a(u);Ee!==!1&&(Ee&&(u=Ee),u.actualize&&(u=u.actualize(h.ownerDocument||b)),J(h,u),be(u))}u=se,p=$}Ze(h,p,U);var He=Ge[h.nodeName];He&&He(h,f)}var x=t,ne=x.nodeType,De=r.nodeType;if(!H){if(ne===ee)De===ee?ye(t,r)||(A(t),x=zt(t,Ft(r.nodeName,r.namespaceURI))):x=r;else if(ne===Je||ne===qe){if(De===ne)return x.nodeValue!==r.nodeValue&&(x.nodeValue=r.nodeValue),x;x=r}}if(x===r)A(t);else{if(r.isSameNode&&r.isSameNode(x))return;if(ie(x,r,H),k)for(var Se=0,je=k.length;Se<je;Se++){var Te=T[k[Se]];Te&&re(Te,Te.parentNode,!1)}}return!H&&x!==t&&t.parentNode&&(x.actualize&&(x=x.actualize(t.ownerDocument||b)),t.parentNode.replaceChild(x,t)),x}}var Vt=Kt(Lt),Ce=Vt;var te=class te{constructor(e=!1){this.debug=e}setDebug(e){this.debug=e}getNodeKey(e){if(e instanceof HTMLElement){for(let t of e.attributes)if(t.name.startsWith("data-on-"))return`${e.tagName}-${t.name}-${t.value}`;if(e.id&&!e.id.startsWith("pywire-uid-"))return e.id;if((e instanceof HTMLInputElement||e instanceof HTMLSelectElement||e instanceof HTMLTextAreaElement)&&e.name)return`${e.tagName}-name-${e.name}`}}getElementSelector(e){if(e.id)return`#${e.id}`;let t=[],r=e;for(;r&&r!==document.body&&t.length<5;){let i=r.tagName.toLowerCase();if(r.id){i=`#${r.id}`,t.unshift(i);break}(r instanceof HTMLInputElement||r instanceof HTMLSelectElement||r instanceof HTMLTextAreaElement)&&r.name&&(i+=`[name="${r.name}"]`);for(let s of r.attributes)if(s.name.startsWith("data-on-")){i+=`[${s.name}="${s.value}"]`;break}if(r.parentElement){let o=Array.from(r.parentElement.children).filter(a=>a.tagName===r.tagName);if(o.length>1){let a=o.indexOf(r)+1;i+=`:nth-of-type(${a})`}}t.unshift(i),r=r.parentElement}return t.join(" > ")}captureFocusState(){let e=document.activeElement;if(!e||e===document.body||e===document.documentElement)return null;let t={selector:this.getElementSelector(e),id:e.id||null,tagName:e.tagName,selectionStart:null,selectionEnd:null,scrollTop:0,scrollLeft:0,value:""};return(e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement)&&(t.selectionStart=e.selectionStart,t.selectionEnd=e.selectionEnd,t.scrollTop=e.scrollTop,t.scrollLeft=e.scrollLeft,t.value=e.value),t}restoreFocusState(e){if(!e)return;let t=null;if(e.id&&(t=document.getElementById(e.id)),!t&&e.selector)try{t=document.querySelector(e.selector)}catch{}if(t&&(t.focus(),t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement)){if(e.value&&t.value!==e.value&&(t.value=e.value),e.selectionStart!==null&&e.selectionEnd!==null)try{t.setSelectionRange(e.selectionStart,e.selectionEnd)}catch{}t.scrollTop=e.scrollTop,t.scrollLeft=e.scrollLeft}}applyUpdate(e,t){te.isUpdating=!0,this.debug&&c.log("[DOMUpdater] Starting update on",e.tagName);try{let r=this.captureFocusState();if(Ce){try{Ce(e,t,{getNodeKey:i=>this.getNodeKey(i),onBeforeElUpdated:(i,s)=>{if(i instanceof HTMLInputElement&&s instanceof HTMLInputElement)if(i.type==="checkbox"||i.type==="radio")s.checked=i.checked;else{let o=s.value||"",a=i.value||"";(a.startsWith(o)||o.startsWith(a))&&(s.value=a)}if(i instanceof HTMLTextAreaElement&&s instanceof HTMLTextAreaElement){let o=s.value||"",a=i.value||"";(a.startsWith(o)||o.startsWith(a))&&(s.value=a)}return i instanceof HTMLSelectElement&&s instanceof HTMLSelectElement&&(i.value&&Array.from(s.options).some(o=>o.value===i.value)?s.value=i.value:i.selectedIndex>=0&&i.selectedIndex<s.options.length&&(s.selectedIndex=i.selectedIndex)),i.id&&i.id.startsWith("pywire-uid-")&&!s.id&&(s.id=i.id),!0},onBeforeElChildrenUpdated:(i,s)=>i instanceof HTMLElement&&i.hasAttribute("data-pywire-permanent")?(this.debug&&c.log("[DOMUpdater] Permanent element detected, skipping children:",i),!1):!0,onBeforeNodeDiscarded:i=>!(i.nodeName==="SCRIPT"||i.nodeName==="STYLE"||i.nodeName==="LINK"||i instanceof Element&&i.hasAttribute("data-pywire-permanent"))})}catch(i){c.error("Morphdom failed:",i),e===document.documentElement&&typeof t=="string"&&(document.open(),document.write(t),document.close())}this.restoreFocusState(r)}else e===document.documentElement&&typeof t=="string"&&(document.open(),document.write(t),document.close())}finally{setTimeout(()=>{te.isUpdating=!1},0)}}update(e){if(/^\s*(<!DOCTYPE|<html)/i.test(e)){this.applyUpdate(document.documentElement,e);return}let r=document.body;if(r||(r=document.createElement("body"),document.documentElement.appendChild(r)),/<body[\s>]/i.test(e)){this.applyUpdate(r,e);return}let s=document.createElement("body");s.innerHTML=e,this.applyUpdate(r,s)}updateRegion(e,t){let r=document.querySelector(`[data-pw-region="${e}"]`);if(!r){this.debug&&c.warn("[DOMUpdater] Region not found:",e);return}this.applyUpdate(r,t),r.getAttribute("data-pw-region")||r.setAttribute("data-pw-region",e)}};te.isUpdating=!1;var E=te;var xe=class xe{constructor(e){this.debouncers=new Map;this.throttlers=new Map;this.supportedEvents=["click","submit","input","change","keydown","keyup","focus","blur","mouseenter","mouseleave","scroll","contextmenu"];this.suppressDuringUpdate=["focus","blur","mouseenter","mouseleave"];this.app=e}debugLog(...e){xe.ENABLE_TRACE&&c.log(...e)}init(){this.supportedEvents.forEach(e=>{let t=e==="mouseenter"||e==="mouseleave"||e==="focus"||e==="blur"||e==="scroll"?{capture:!0}:void 0;document.addEventListener(e,r=>this.handleEvent(r),t)})}getHandlers(e,t){let r=`data-on-${t}`,i=e.getAttribute(r);if(!i)return[];if(i.trim().startsWith("["))try{let s=JSON.parse(i);if(Array.isArray(s))return s.flatMap(o=>{if(!o||typeof o!="object")return[];let a="handler"in o&&typeof o.handler=="string"?o.handler:null;if(!a)return[];let d="modifiers"in o&&Array.isArray(o.modifiers)?o.modifiers.filter(w=>typeof w=="string"):[],g="args"in o&&Array.isArray(o.args)?o.args:void 0;return[{name:a,modifiers:d,args:g}]})}catch(s){c.error("Error parsing event handlers:",s)}else{let s=e.getAttribute(`data-modifiers-${t}`),o=s?s.split(" ").filter(a=>a):[];return[{name:i,modifiers:o,args:void 0}]}return[]}async handleEvent(e){let t=e.type;if(E.isUpdating&&this.suppressDuringUpdate.includes(t)){this.debugLog("[Handler] SUPPRESSING event during update:",t,"isUpdating=",E.isUpdating);return}this.debugLog("[Handler] Processing event:",t,"isUpdating=",E.isUpdating);let r=e.composedPath?e.composedPath():[],i=!1;for(let s of r){if(i)break;if(s instanceof HTMLElement){let o=s,a=this.getHandlers(o,t);if(a.length>0){this.debugLog("[handleEvent] Found handlers on",o.tagName,a);for(let d of a)!d.modifiers.includes("window")&&!d.modifiers.includes("outside")&&(this.processEvent(o,t,d.name,d.modifiers,e,d.args),e.cancelBubble&&(i=!0))}}}this.handleGlobalEvent(e)}handleGlobalEvent(e){let t=e.type,r=`[data-modifiers-${t}*="window"]`,i=`[data-modifiers-${t}*="outside"]`;document.querySelectorAll(`${r}, ${i}`).forEach(o=>{if(!(o instanceof HTMLElement))return;let a=this.getHandlers(o,t);for(let d of a)if(d.modifiers.includes("window")&&this.processEvent(o,t,d.name,d.modifiers,e,d.args),d.modifiers.includes("outside")){let g=e.target;g&&!o.contains(g)&&this.processEvent(o,t,d.name,d.modifiers,e,d.args)}})}processEvent(e,t,r,i,s,o){if(this.debugLog("[processEvent]",t,"handler:",r,"modifiers:",i),(i.includes("prevent")||t==="submit")&&(this.debugLog("[processEvent] Calling preventDefault"),s.preventDefault()),i.includes("stop")&&s.stopPropagation(),i.includes("self")&&s.target!==e||i.includes("shift")&&(!("shiftKey"in s)||!s.shiftKey)||i.includes("ctrl")&&(!("ctrlKey"in s)||!s.ctrlKey)||i.includes("alt")&&(!("altKey"in s)||!s.altKey)||i.includes("meta")&&(!("metaKey"in s)||!s.metaKey)||i.includes("cmd")&&(!("metaKey"in s)||!s.metaKey))return;if(s instanceof KeyboardEvent){let m=["enter","escape","space","tab","up","down","left","right"],A=["shift","ctrl","alt","meta","cmd","window","outside","prevent","stop","self","debounce","throttle"],Y=i.filter(S=>A.includes(S)||S.startsWith("debounce")||S.startsWith("throttle")||S.endsWith("ms")?!1:m.includes(S)||S.length===1);if(Y.length>0){let S=s.key.toLowerCase();this.debugLog("[processEvent] Key check. Pressed:",S,"Modifiers:",Y);let J={escape:"escape",esc:"escape",enter:"enter",space:" ",spacebar:" "," ":" ",tab:"tab",up:"arrowup",arrowup:"arrowup",down:"arrowdown",arrowdown:"arrowdown",left:"arrowleft",arrowleft:"arrowleft",right:"arrowright",arrowright:"arrowright"},H=J[S]||S,T=!1;for(let k of Y){let M=J[k]||k;if(this.debugLog("[processEvent] Comparing constraint:",k,"->",M,"vs",H,"code:",s.code),M===H){T=!0;break}if(s.code&&s.code.toLowerCase()===`key${M}`){T=!0;break}}if(!T){this.debugLog("[processEvent] No key match found.");return}}}let a=i.find(m=>m.startsWith("debounce")),d=i.find(m=>m.startsWith("throttle")),w=`${e.id||this.getUniqueId(e)}-${t}-${r}`;if(a){let m=this.parseDuration(i,250);this.debouncers.has(w)&&window.clearTimeout(this.debouncers.get(w));let A=window.setTimeout(()=>{this.debouncers.delete(w),this.dispatchEvent(e,t,r,s,o)},m);this.debouncers.set(w,A);return}if(d){let m=this.parseDuration(i,250);if(this.throttlers.has(w))return;this.throttlers.set(w,Date.now()),this.dispatchEvent(e,t,r,s,o),window.setTimeout(()=>{this.throttlers.delete(w)},m);return}this.dispatchEvent(e,t,r,s,o)}dispatchEvent(e,t,r,i,s){let o={};s&&s.length>0?s.forEach((d,g)=>{o[`arg${g}`]=d}):o=this.getArgs(e);let a={type:t,id:e.id,args:o};if(e instanceof HTMLInputElement?(a.value=e.value,(e.type==="checkbox"||e.type==="radio")&&(a.checked=e.checked)):(e instanceof HTMLTextAreaElement||e instanceof HTMLSelectElement)&&(a.value=e.value),i instanceof KeyboardEvent&&(a.key=i.key,a.keyCode=i.keyCode),t==="submit"&&e instanceof HTMLFormElement){let d=new FormData(e),g={};d.forEach((w,m)=>{w instanceof File||(g[m]=w.toString())}),a.formData=g}this.app.sendEvent(r,a)}parseDuration(e,t){let r=e.findIndex(a=>a.startsWith("debounce")),i=e.findIndex(a=>a.startsWith("throttle")),s=r!==-1?r:i;if(s!==-1&&e[s+1]){let a=e[s+1];if(a.endsWith("ms")){let d=parseInt(a);if(!isNaN(d))return d}}let o=e[s];if(o&&o.includes("-")){let a=o.split("-"),d=parseInt(a[1]);if(!isNaN(d))return d}return t}getUniqueId(e){return e.id||(e.id="pywire-uid-"+Math.random().toString(36).substr(2,9)),e.id}getArgs(e){let t={};if(e instanceof HTMLElement){for(let r in e.dataset)if(r.startsWith("arg"))try{t[r]=JSON.parse(e.dataset[r]||"null")}catch{t[r]=e.dataset[r]}}return t}};xe.ENABLE_TRACE=!1;var we=xe;var Xt={autoInit:!0,enableWebTransport:!1,enableWebSocket:!0,enableHTTP:!0,debug:!1},K=class{constructor(e={}){this.initialized=!1;this.siblingPaths=[];this.pathRegexes=[];this.pjaxEnabled=!1;this.isConnected=!1;this.config={...Xt,...e},c.setDebug(!!this.config.debug),this.transport=new O(this.config),this.updater=new E(this.config.debug),this.eventHandler=new we(this)}getConfig(){return this.config}async init(){if(!this.initialized){this.initialized=!0,this.transport.onMessage(e=>this.handleMessage(e)),this.transport.onStatusChange(e=>this.handleStatusChange(e));try{await this.transport.connect()}catch(e){c.error("PyWire: Failed to connect:",e)}this.loadSPAMetadata(),this.setupSPANavigation(),this.eventHandler.init(),c.log(`PyWire: Initialized (transport: ${this.transport.getActiveTransport()}, spa_paths: ${this.siblingPaths.length}, pjax: ${this.pjaxEnabled})`)}}handleStatusChange(e){this.isConnected=e,e&&this.transport.send({type:"init",path:window.location.pathname+window.location.search})}loadSPAMetadata(){let e=document.getElementById("_pywire_spa_meta");if(e)try{let t=JSON.parse(e.textContent||"{}");this.siblingPaths=t.sibling_paths||[],this.pjaxEnabled=!!t.enable_pjax,t.debug!==void 0&&(this.config.debug=!!t.debug,c.setDebug(!!t.debug),this.updater.setDebug(!!t.debug)),this.pathRegexes=this.siblingPaths.map(r=>this.patternToRegex(r))}catch(t){c.warn("PyWire: Failed to parse SPA metadata",t)}}patternToRegex(e){let t=e.replace(/[.+?^${}()|[\]\\]/g,"\\$&");return t=t.replace(/:(\\w+)(:\\w+)?/g,"([^/]+)"),t=t.replace(/\\{(\\w+)(:\\w+)?\\}/g,"([^/]+)"),new RegExp(`^${t}$`)}isSiblingPath(e){return this.pathRegexes.some(t=>t.test(e))}setupSPANavigation(){window.addEventListener("popstate",()=>{this.sendRelocate(window.location.pathname+window.location.search)}),!(this.siblingPaths.length===0&&!this.pjaxEnabled)&&document.addEventListener("click",e=>{let t=e.target.closest("a[href]");if(!t||t.origin!==window.location.origin||t.hasAttribute("download")||t.target==="_blank")return;let r=!1;(this.pjaxEnabled||this.isSiblingPath(t.pathname))&&(r=!0),t.hasAttribute("data-pywire-reload")&&(r=!1),r&&(e.preventDefault(),this.navigateTo(t.pathname+t.search))})}navigateTo(e){if(!this.isConnected){c.warn("PyWire: Navigation blocked - Offline");return}history.pushState({},"",e),this.sendRelocate(e)}sendRelocate(e){let t={type:"relocate",path:e};this.transport.send(t)}sendEvent(e,t){let r={type:"event",handler:e,path:window.location.pathname+window.location.search,data:t};this.transport.send(r)}async handleMessage(e){switch(e.type){case"update":e.regions&&e.regions.length>0?e.regions.forEach(t=>{this.updater.updateRegion(t.region,t.html)}):e.html&&this.updater.update(e.html);break;case"reload":c.log("PyWire: Reloading..."),window.location.reload();break;case"error":c.error("PyWire: Server error:",e.error);break;case"error_trace":c.error("PyWire: Error:",e.error);break;case"console":if(e.lines&&e.lines.length>0){let t="PyWire Server:",r=e.lines.join(`
`);e.level==="error"?c.error(t,r):e.level==="warn"?c.warn(t,r):c.log(t,r)}break;case"init":c.log(`PyWire Client v${Ve} \u2022 Server v${e.version}`);break;default:c.warn("PyWire: Unknown message type",e)}}getTransport(){return this.transport.getActiveTransport()}disconnect(){this.transport.disconnect()}};var V=class{constructor(){this.element=null;this.create()}create(){this.element=document.createElement("div"),this.element.style.cssText=`
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            font-family: system-ui, -apple-system, sans-serif;
            font-size: 14px;
            z-index: 10000;
            display: none;
            transition: opacity 0.3s;
            pointer-events: none;
        `,document.body.appendChild(this.element)}update(e){this.element&&(e?this.element.style.display="none":(this.element.textContent="Connection Lost - Reconnecting...",this.element.style.display="block",this.element.style.backgroundColor="rgba(0, 0, 0, 0.8)"))}showNavigationBlocked(){this.element&&(this.element.style.backgroundColor="rgba(200, 0, 0, 0.9)",this.element.textContent="Cannot navigate - Offline",this.element.style.display="block",setTimeout(()=>{this.element&&(this.element.style.backgroundColor="rgba(0, 0, 0, 0.8)")},1500))}};var X=class{constructor(){this.loadedSources=new Set}getVirtualUrl(e){let t=btoa(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,""),r=e.split(/[/\\]/).pop()||"unknown";return`${window.location.origin}/_pywire/file/${t}/${r}`}async handle(e,t){let r=new Set;for(let o of t)this.loadedSources.has(o.filename)||r.add(o.filename);await Promise.all(Array.from(r).map(async o=>{try{let a=this.getVirtualUrl(o),d=`/_pywire/source?path=${encodeURIComponent(o)}`,g=await fetch(d);if(g.ok){let m=`${await g.text()}
//# sourceURL=${a}`;try{(0,eval)(m)}catch{}this.loadedSources.add(o)}this.loadedSources.add(o)}catch(a){console.warn("PyWire: Failed to load source",o,a)}}));let i=new Error(e),s=[`${i.name}: ${i.message}`];for(let o of t){let a=o.name||"<module>",d=this.getVirtualUrl(o.filename),g=o.colno??1;s.push(`    at ${a} (${d}:${o.lineno}:${g})`)}i.stack=s.join(`
`),console.error(i.stack)}};var G=class extends K{constructor(t={}){super(t);this.overlay=null;this.errorHandler=new X}async init(){this.overlay=new V,await super.init()}handleStatusChange(t){super.handleStatusChange(t),this.overlay&&this.overlay.update(t)}navigateTo(t){if(!this.isConnected){c.warn("PyWire: Navigation blocked - Offline"),this.overlay&&this.overlay.showNavigationBlocked();return}super.navigateTo(t)}async handleMessage(t){switch(t.type){case"error_trace":t.trace&&await this.errorHandler.handle(t.error||"Unknown Error",t.trace);return;case"console":if(t.lines&&t.lines.length>0){let r="PyWire Server:",i=t.lines.join(`
`);t.level==="error"?(console.group(r+" Error"),c.error(i),console.groupEnd()):t.level==="warn"?(console.groupCollapsed(r+" Warning"),c.warn(i),console.groupEnd()):t.lines.length===1?c.log(r,i):(console.groupCollapsed(r+" Log"),c.log(i),console.groupEnd())}return;default:await super.handleMessage(t)}}};var Le=new G;document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>Le.init()):Le.init();return ot(Gt);})();
